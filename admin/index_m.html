<html>

<head>

	<!-- Load ioBroker scripts and styles-->
	<link rel="stylesheet" type="text/css" href="../../lib/css/fancytree/ui.fancytree.min.css" />
	<link rel="stylesheet" type="text/css" href="../../css/adapter.css" />
	<link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">

	<script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="../../socket.io/socket.io.js"></script>

	<script type="text/javascript" src="../../lib/js/materialize.js"></script>
	<script type="text/javascript" src="../../lib/js/jquery-ui.min.js"></script>
	<script type="text/javascript" src="../../lib/js/jquery.fancytree-all.min.js"></script>

	<script type="text/javascript" src="../../js/translate.js"></script>
	<script type="text/javascript" src="../../lib/js/selectID.js"></script>
	<script type="text/javascript" src="../../js/adapter-settings.js"></script>
	<script type="text/javascript" src="actions.js"></script>

	<!-- Load our own files -->
	<link rel="stylesheet" type="text/css" href="style.css" />
	<script type="text/javascript" src="words.js"></script>

	<script type="text/javascript">
		// This will be called by the admin adapter when the settings page loads
		function load(settings, onChange) {
			// Namespace bauen
			var myNamespace = adapter + '.' + instance

			// example: select elements with id=key and class=value and insert value
			if (!settings) return;
			$('.value').each(function () {
				var $key = $(this);
				var id = $key.attr('id');
				if ($key.attr('type') === 'checkbox') {
					// do not call onChange direct, because onChange could expect some arguments
					$key.prop('checked', settings[id])
						.on('change', () => onChange())
						;
				} else {
					// do not call onChange direct, because onChange could expect some arguments
					$key.val(settings[id])
						.on('change', () => onChange())
						.on('keyup', () => onChange())
						;
				}
			});


			getIsAdapterAlive(function (isAlive) {
				// var $btnRefresh = $('.btn-refresh');

				// $btnRefresh.on('click', function () {
				// 	readLinkedObjects();
				// });
			});

			// Tabelle füllen
			getForeignObjects(myNamespace + '.*', function (err, list) {
				// alle linkedObject der Instanz holen
				if (!err) {
					let tableData = [];		// Array für tableFkt

					for (var id in list) {
						// benötigte Daten in Array für tableFkt packen
						let linkedObj = list[id];

						if (linkedObj && linkedObj.common && linkedObj.common.custom && linkedObj.common.custom[myNamespace]) {
							let parentId = '';

							if (linkedObj.common.custom[myNamespace].isLinked) {
								// Verlinkung exitsiert -> parentId übergeben
								parentId = linkedObj.common.custom[myNamespace].parentId
							}

							tableData.push({ "linkedId": id, "parentId": parentId, "isLinked": linkedObj.common.custom[myNamespace].isLinked });
						}
					}

					// Daten an Tabelle übergeben und anzeigen
					myValues2table('events', tableData, onChange, tableOnReady);

				} else {
					showError(err.message);
				}
			});

			onChange(false);

			// reinitialize all the Materialize labels on the page if you are dynamically adding inputs:
			if (M) M.updateTextFields();
		}

		// This will be called by the admin adapter when the user presses the save button
		function save(callback) {
			// example: select elements with class=value and build settings object
			var obj = {};
			$('.value').each(function () {
				var $this = $(this);
				if ($this.attr('type') === 'checkbox') {
					obj[$this.attr('id')] = $this.prop('checked');
				} else {
					obj[$this.attr('id')] = $this.val();
				}
			});
			callback(obj);
		}

		function tableOnReady() {
			$('#events .table-values-div .table-values .values-buttons[data-command="edit"]').on('click', function () {
				let id = $(this).data('index');
				initSelectId(function (sid) {
					sid.selectId('show', $('#events .values-input[data-name="linkedId"][data-index="' + id + '"]').val(), function (newId) {
						if (newId) {
							$('#events .values-input[data-name="linkedId"][data-index="' + id + '"]').val(newId).trigger('change');
							socket.emit('getObject', newId, function (err, obj) {
								$('#events .values-input[data-name="parentId"][data-index="' + id + '"]').val(obj._id).trigger('change');
							});
						}
					});
				});
			});
		}

		var selectId;
		function initSelectId(callback) {
			if (selectId) {
				return callback(selectId);
			}
			socket.emit('getObjects', function (err, objs) {
				selectId = $('#dialog-select-member').selectId('init', {
					noMultiselect: true,
					objects: objs,
					imgPath: '../../lib/css/fancytree/',
					filter: { type: 'state' },
					name: 'scenes-select-state',
					texts: {
						select: _('Select'),
						cancel: _('Cancel'),
						all: _('All'),
						id: _('ID'),
						name: _('Name'),
						role: _('Role'),
						room: _('Room'),
						value: _('Value'),
						selectid: _('Select ID'),
						from: _('From'),
						lc: _('Last changed'),
						ts: _('Time stamp'),
						wait: _('Processing...'),
						ack: _('Acknowledged'),
						selectAll: _('Select all'),
						unselectAll: _('Deselect all'),
						invertSelection: _('Invert selection')
					},
					columns: ['image', 'name', 'role', 'room']
				});
				callback(selectId);
			});
		}

		function getForeignObjects(pattern, callback) {
			socket.emit('getForeignObjects', pattern, function (err, res) {
				if (!err && res) {
					if (callback) callback(err, res);
				} else {
					if (callback) callback(null);
				}
			});
		}

		function myValues2table(divId, values, onChange, onReady, maxRaw) {
			if (typeof values === 'function') {
				typeof onChange === 'number' ? maxRaw = onChange : maxRaw = null;
				onChange = values;
				values = divId;
				divId = '';
			}

			if (typeof onReady === 'number') {
				maxRaw = onReady;
				onReady = null;
			} else if (typeof maxRaw === 'undefined') {
				maxRaw = null;
			}

			values = values || [];
			var names = [];
			var $div;
			if (!divId) {
				$div = $('body');
			} else {
				$div = $('#' + divId);
			}
			var $add = $div.find('.table-button-add');
			$add.data('raw', values.length);

			if (maxRaw) {
				$add.data('maxraw', maxRaw);
			}

			if (!$add.data('inited')) {
				$add.data('inited', true);

				var addText = $add.text();

				if (!isMaterialize) {
					$add.button({
						icons: { primary: 'ui-icon-plus' },
						text: !!addText,
						label: addText ? _(addText) : undefined
					});
				}

				$add.on('click', function () {
					if (!$add.data('maxraw') || ($add.data('raw') < $add.data('maxraw'))) {
						var $table = $div.find('.table-values');
						var values = $table.data('values');
						var names = $table.data('names');
						var obj = {};
						for (var i = 0; i < names.length; i++) {
							if (!names[i]) continue;
							obj[names[i].name] = names[i].def;
						}
						values.push(obj);
						onChange && onChange();
						setTimeout(function () {
							myValues2table(divId, values, onChange, onReady);
						}, 100);
						$add.data('raw', $add.data('raw') + 1);
					} else {
						confirmMessage(_('maxTableRaw') + ': ' + $add.data('maxraw'), _('maxTableRawInfo'), 'alert', ['Ok']);
					}
				});
			}

			if (values) {
				var buttons = [];
				var $table = $div.find('.table-values');
				$table.data('values', values);

				$table.find('th').each(function () {
					var name = $(this).data('name');
					if (name) {
						var obj = {
							name: name,
							type: $(this).data('type') || 'text',
							def: $(this).data('default'),
							style: $(this).data('style'),
							tdstyle: $(this).data('tdstyle')
						};
						if (obj.type === 'checkbox') {
							if (obj.def === 'false') obj.def = false;
							if (obj.def === 'true') obj.def = true;
							obj.def = !!obj.def;
						} else if (obj.type === 'select' || obj.type === 'select multiple') {
							var vals = ($(this).data('options') || '').split(';');
							obj.options = {};
							for (var v = 0; v < vals.length; v++) {
								var parts = vals[v].split('/');
								obj.options[parts[0]] = _(parts[1] || parts[0]);
								if (v === 0) obj.def = (obj.def === undefined) ? parts[0] : obj.def;
							}
						} else {
							obj.def = obj.def || '';
						}
						names.push(obj);
					} else {
						names.push(null);
					}

					name = $(this).data('buttons');

					if (name) {
						var bs = name.split(' ');
						buttons.push(bs);
					} else {
						buttons.push(null);
					}
				});

				$table.data('names', names);

				var text = '';
				for (var v = 0; v < values.length; v++) {
					var idName = values[v] && values[v].id;
					if (!idName && values[v]) {
						if (names[0] === '_index') {
							idName = values[v][names[1]];
						} else {
							idName = values[v][names[0]];
						}
					}
					text += '<tr ' + (idName ? 'data-id="' + idName + '"' : '') + ' data-index="' + v + '">';

					for (var i = 0; i < names.length; i++) {
						text += '<td';
						var line = '';
						var style = '';
						var tdstyle = '';
						if (names[i]) {
							if (names[i].name !== '_index') {
								tdstyle = names[i].tdstyle || '';
								if (tdstyle && tdstyle[0] !== ';') tdstyle = ';' + tdstyle;
							}
							if (names[i].name === '_index') {
								style = (names[i].style ? names[i].style : 'text-align: right;');
								line += (v + 1);
							} else if (names[i].type === 'checkbox') {
								// Mod für disabled Checkbox
								line += '<input style="' + (names[i].style || '') + '" class="values-input filled-in" type="checkbox" data-index="' + v + '" data-name="' + names[i].name + '" ' + (values[v][names[i].name] ? 'checked' : '') + '" data-old-value="' + (values[v][names[i].name] === undefined ? '' : values[v][names[i].name]) + '" disabled="true"/>';
								if (isMaterialize) {
									line += '<span></span>';
								}
							} else if (names[i].type.substring(0, 6) === 'select') {
								line += (names[i].type.substring(7, 16) === 'multiple' ? '<select multiple style="' : '<select style="') + (names[i].style ? names[i].style : 'width: 100%') + '" class="values-input" data-index="' + v + '" data-name="' + names[i].name + '">';
								var options;
								if (names[i].name === 'room') {
									options = $table.data('rooms');
								} else if (names[i].name === 'func') {
									options = $table.data('functions');
									if (names[i].type === 'select multiple') delete options[_('none')];
								} else {
									options = names[i].options;
								}

								var val = (values[v][names[i].name] === undefined ? '' : values[v][names[i].name]);
								if (typeof val !== 'object') val = [val];
								for (var p in options) {
									line += '<option value="' + p + '" ' + (val.indexOf(p) !== -1 ? ' selected' : '') + '>' + options[p] + '</option>';
								}
								line += '</select>';
							} else {
								// Mod für readonly input (text)
								line += '<input class="values-input" style="' + (names[i].style ? names[i].style : 'width: 100%') + '" type="' + names[i].type + '" data-index="' + v + '" data-name="' + names[i].name + '" readonly/>';
							}
						}

						if (buttons[i]) {
							style = 'text-align: center; white-space: nowrap;';
							for (var b = 0; b < buttons[i].length; b++) {
								if ((!v && buttons[i][b] === 'up') || (v === values.length - 1 && buttons[i][b] === 'down')) {
									if (isMaterialize) {
										line += '<a data-command="' + buttons[i][b] + '" class="values-buttons btn-floating btn-small waves-effect waves-light disabled"><i class="material-icons">add</i></a>';
									} else {
										line += '<button data-command="' + buttons[i][b] + '" class="values-buttons" disabled>&nbsp;</button>';
									}
								} else {
									if (isMaterialize) {
										line += '<a data-index="' + v + '" data-command="' + buttons[i][b] + '" class="values-buttons btn-floating btn-small waves-effect waves-light"><i class="material-icons">add</i></a>';
									} else {
										line += '<button data-index="' + v + '" data-command="' + buttons[i][b] + '" class="values-buttons"></button>';
									}
								}
							}
						}
						if (style.length || tdstyle.length) {
							text += ' style="' + style + tdstyle + '">' + line + '</td>';
						} else {
							text += '>' + line + '</td>';
						}
					}

					text += '</tr>';
				}
				var $lines = $div.find('.table-lines');
				if (!$lines.length) {
					$table.append('<tbody class="table-lines"></tbody>');
					$lines = $div.find('.table-lines');
				}

				$lines.html(text);

				$lines.find('.values-input').each(function () {
					var $this = $(this);
					var type = $this.attr('type');
					var name = $this.data('name');
					var id = $this.data('index');
					$this.data('old-value', values[id][name]);
					if (type === 'checkbox') {
						$this.prop('checked', values[id][name]);
					} else {
						$this.val(values[id][name]);
					}
				});
				$lines.find('.values-buttons').each(function () {
					var command = $(this).data('command');
					if (command === 'copy') {
						if (!isMaterialize) {
							$(this).button({
								icons: { primary: 'ui-icon-copy' },
								text: false
							})
								.css({ width: '1em', height: '1em' });
						} else {
							$(this).find('i').html('content_copy');
						}

						$(this).on('click', function () {
							if (!$add.data('maxraw') || ($add.data('raw') < $add.data('maxraw'))) {
								var id = $(this).data('index');
								var elem = JSON.parse(JSON.stringify(values[id]));
								values.push(elem);
								onChange && onChange();

								setTimeout(function () {
									if (typeof tableEvents === 'function') {
										tableEvents(values.length - 1, elem, 'add');
									}

									myValues2table(divId, values, onChange, onReady);
								}, 100);

								if ($add.data('maxraw')) {
									$add.data('raw', $add.data('raw') + 1);
								}
							}
						});
					} else
						if (command === 'delete') {
							if (!isMaterialize) {
								$(this).button({
									icons: { primary: 'ui-icon-trash' },
									text: false
								})
									.css({ width: '1em', height: '1em' });
							} else {
								$(this).addClass('red').find('i').html('delete');
							}

							$(this).on('click', function () {
								var id = $(this).data('index');
								var elem = values[id];
								values.splice(id, 1);
								onChange && onChange();

								setTimeout(function () {
									if (typeof tableEvents === 'function') {
										tableEvents(id, elem, 'delete');
									}

									myValues2table(divId, values, onChange, onReady);
								}, 100);

								if ($add.data('maxraw')) {
									$add.data('raw', $add.data('raw') - 1);
								}
							});
						} else if (command === 'up') {
							if (!isMaterialize) {
								$(this).button({
									icons: { primary: 'ui-icon-triangle-1-n' },
									text: false
								})
									.css({ width: '1em', height: '1em' })
							} else {
								$(this).find('i').html('arrow_upward');
							}
							$(this).on('click', function () {
								var id = $(this).data('index');
								var elem = values[id];
								values.splice(id, 1);
								values.splice(id - 1, 0, elem);
								onChange && onChange();
								setTimeout(function () {
									myValues2table(divId, values, onChange, onReady);
								}, 100);
							});
						} else if (command === 'down') {
							if (!isMaterialize) {
								$(this).button({
									icons: { primary: 'ui-icon-triangle-1-s' },
									text: false
								})
									.css({ width: '1em', height: '1em' });
							} else {
								$(this).find('i').html('arrow_downward');
							}
							$(this).on('click', function () {
								var id = $(this).data('index');
								var elem = values[id];
								values.splice(id, 1);
								values.splice(id + 1, 0, elem);
								onChange && onChange();
								setTimeout(function () {
									myValues2table(divId, values, onChange, onReady);
								}, 100);
							});
						} else if (command === 'pair') {
							if (!isMaterialize) {
								$(this).button({
									icons: { primary: 'ui-icon-transferthick-e-w' },
									text: false
								})
									.css({ width: '1em', height: '1em' });
							} else {
								$(this).find('i').html('leak_add');
							}
							$(this).on('click', function () {
								if (typeof tableEvents === 'function') {
									var id = $(this).data('index');
									var elem = values[id];
									tableEvents(id, elem, 'pair');
								}
							}).attr('title', _('pair'));
						} else if (command === 'unpair') {
							if (!isMaterialize) {
								$(this).button({
									icons: { primary: 'ui-icon-scissors' },
									text: false
								})
									.css({ width: '1em', height: '1em' });
							} else {
								$(this).find('i').html('leak_remove');
							}
							$(this).on('click', function () {
								if (typeof tableEvents === 'function') {
									var id = $(this).data('index');
									var elem = values[id];
									tableEvents(id, elem, 'unpair');
								}
							}).attr('title', _('unpair'));
						} else if (command === 'edit') {
							if (!isMaterialize) {
								$(this).button({
									icons: { primary: 'ui-icon-pencil' },
									text: false
								})
									.css({ width: '1em', height: '1em' });
							} else {
								$(this).find('i').html('edit');
							}
							$(this).on('click', function () {
								var id = $(this).data('index');
								if (typeof editLine === 'function') {
									setTimeout(function () {
										editLine(id, JSON.parse(JSON.stringify(values[id])), function (err, id, newValues) {
											if (!err) {
												if (JSON.stringify(values[id]) !== JSON.stringify(newValues)) {
													onChange && onChange();
													values[id] = newValues;
													myValues2table(divId, values, onChange, onReady);
												}
											}
										});
									}, 100);
								}
							});
						}
				});

				$lines.find('.values-input').on('change.adaptersettings', function () {
					if ($(this).attr('type') === 'checkbox') {
						if ($(this).prop('checked').toString() !== $(this).data('old-value')) onChange();
						values[$(this).data('index')][$(this).data('name')] = $(this).prop('checked');
					} else {
						if ($(this).val() !== $(this).data('old-value')) onChange();
						values[$(this).data('index')][$(this).data('name')] = $(this).val();
					}
				}).on('keyup', function () {
					$(this).trigger('change.adaptersettings');
				});
			}
			if (isMaterialize) {
				if (!divId) {
					M.updateTextFields();
					$('select').select();
				} else {
					M.updateTextFields('#' + divId);
					$('#' + divId).find('select').select();
				}

				// workaround for materialize checkbox problem
				$div.find('input[type="checkbox"]+span').off('click').on('click', function () {
					var $input = $(this).prev();
					if (!$input.prop('disabled')) {
						$input.prop('checked', !$input.prop('checked')).trigger('change');
					}
				});
			}
			if (typeof onReady === 'function') onReady();
		}

	</script>
	<style>
		.table-values thead {
			background: gray;
			color: white;
		}
	</style>
</head>

<body>

	<div class="m adapter-container">
		<div class="row">
			<div class="row">
				<div class="col s12 m4 l2">
					<img src="linkeddevices.png" class="logo">
				</div>
			</div>

			<!-- Put your content here -->

			<!-- For example columns with settings: -->
			<div class="row">
				<div class="col s6 input-field">
					<input type="checkbox" class="value" id="notDeleteDeadLinkedObjects" />
					<label for="notDeleteDeadLinkedObjects" class="translate">notDeleteDeadLinkedObjects</label>
				</div>

				<div class="col s6 input-field">
					<input type="text" class="value" id="option2" />
					<label for="option2" class="translate">option2</label>
				</div>
			</div>
			<div class="row">
				<div class="col s12" id="events">
					<div class="table-values-div">
						<table class="table-values">
							<thead>
								<tr>
									<th data-name="_index"></th>
									<th data-name="linkedId" data-type="text" class="translate">id of linked object</th>
									<th data-buttons="edit" style="width: 70px"></th>
									<th data-name="parentId" data-type="text" class="translate">linked with</th>
									<th data-name="isLinked" style="width: 70px" data-style="width: 70px"
										data-type="checkbox" class="translate">is linked</th>
								</tr>
							</thead>
						</table>
					</div>
				</div>
			</div>
		</div>
		<!-- Layout für Select Objekt Id Dialog -->
		<div id="dialog-select-member" class="modal modal-fixed-footer">
			<div class="modal-content">
				<div class="row">
					<div class="col s12 title"></div>
				</div>
				<div class="row">
					<div class="col s12 dialog-content">
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<a class="modal-action modal-close waves-effect waves-green btn btn-set"><i
						class="large material-icons left">check</i><span class="translate">Select</span></a>
				<a class="modal-action modal-close waves-effect waves-green btn btn-close"><i
						class="large material-icons left ">close</i><span class="translate">Cancel</span></a>
			</div>
		</div>
	</div>
</body>

</html>