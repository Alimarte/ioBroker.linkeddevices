<script type="text/x-iobroker" data-template-name="linkeddevices">
	<div class="row">
		<div class="col s2 c_ParentObj_Enabled">
			<input type="checkbox" data-field="enabled" data-default="false"/>
			<!-- this field is mandatory, just to find out if to include this settings or not</span-->
			<span class="translate">enabled</span>
		</div>
		
		<div class="col s2 c_LinkedObj_isLinked">
			<input type="checkbox" id="isLinked" disabled="true"/>
			<span class="translate">is linked</span>
		</div>

		<div class="col s4">
			<div class="section s_ParentObj_Input_LinkedId">
				<div class="row">
					<div class="col s8">
						<label class="translate">prefix for id of linked object</label>
						<input type="text" id="prefixId" size="30">
					</div>
					<div class="col s4">
						<label class="translate">id of linked object</label>
						<input type="text" id="stateId" size="30">
					</div>					
				</div>
			</div>

			<div class="section s_ParentObj_Name">
				<label class="translate">name of linked object</label>
				<input type="text" data-field="name" size="30">
			</div>

			<div class="section s_LinkedObj_parentId">
				<label class="translate">linked with</label>
				<input type="text" id="parentId" size="30" readonly>					
			</div>
		</div>
		
		<div class="col s4">
			<div class="section s_ParentObj_LinkedId">
				<label class="translate">composite id of linked object</label>
				<input type="text" data-field="linkedId" size="30" readonly>				
			</div>
			<div class="section s_test">
					<label class="translate">test</label>
					<input type="text" id="test" size="30" readonly>				
			</div>
		</div>
	</div>
	<div class="row c_ParentObj_ExpertSettings">
		<div class="col s2">
			<input type="checkbox" id="expertSettings"/>
			<span class="translate">expert settings</span>
		</div>
		<div class="col s4">
			<div class="section s_ParentObj_hasUnit">
				<label id="labelUnit" class="translate">change unit '{0}' for linked object to</label>
				<input type="text" data-field="unit" size="30" disabled="true">
			</div>
		
			<div class="section s_ParentObj_conversion">
				<div class="row">
					<div class="col s2">
						<select id="conversionType" disabled="true">
							<option value="xml">+ | -</option>
							<option value="bin">* | /</option>
						</select>
						<span class="translate">conversion</span>
					</div>
							
					<div class="col s10">
						<input type="text" data-field="conversion" size="30" disabled="true">
						<span class="translate">conversion</span>
					</div>
				</div>
			</div>
		</div>
	</div>

</script>

<script type="text/javascript">
	$.get("adapter/linkeddevices/words.js", function (script) {
		let translation = script.substring(script.indexOf('{'), script.length);
		translation = translation.substring(0, translation.lastIndexOf(';'));
		$.extend(systemDictionary, JSON.parse(translation));
	});

	// There are two ways how to predefine default settings:
	// - with attribute "data-default" (content independent)
	// - with function in global variable "defaults". Function name is equal with adapter name.
	//   as input function receives object with all information concerning it

	// Objekt holen für das der custom Dialog geöffnet wurde 
	var currentObj = gMain.objects[gMain.navigateGetParams()];

	if (typeof defaults !== 'undefined') {
		defaults.linkeddevices = function (obj, instanceObj) {
			return {
				enabled: false,
				unit: obj.common.unit
			};
		}
	}

	if (typeof customPostInits !== 'undefined') {
		customPostInits.linkeddevices = function ($div, values, instanceObj, type, role) {

			$div.find('input[id="test"]').val(JSON.stringify(currentObj));

			if (values["linkedId"]) {
				var linkedId = values["linkedId"];

				if (values["linkedId"].indexOf(".") > 0) {
					$div.find('input[id="stateId"]').val(linkedId.substring(linkedId.lastIndexOf(".") + 1, linkedId.length));
					$div.find('input[id="prefixId"]').val(linkedId.substring(0, linkedId.lastIndexOf(".")));
				} else {
					$div.find('input[id="stateId"]').val(linkedId);
				}
			} else if (currentObj && currentObj._id) {
				var objId = currentObj._id;
				$div.find('input[id="stateId"]').val(objId.substring(objId.lastIndexOf(".") + 1, objId.length));
				$div.find('input[data-field="linkedId"]').val(objId.substring(objId.lastIndexOf(".") + 1, objId.length));
			}

			if (values["isLinked"] != undefined) {
				//linkedObject
				$div.find('.c_ParentObj_Enabled').hide();
				$div.find('.s_ParentObj_LinkedId').hide();
				$div.find('.s_ParentObj_Name').hide();
				$div.find('.s_ParentObj_Input_LinkedId').hide();

				$div.find('.c_LinkedObj_isLinked').show();
				$div.find('input[id="isLinked"]').prop('checked', values["isLinked"]);

				$div.find('.s_LinkedObj_parentId').show();
				$div.find('input[id="parentId"]').val(values["parentId"]);

				$div.find('.c_ParentObj_ExpertSettings').hide();
			} else {
				//parentObject
				$div.find('.c_ParentObj_Enabled').show();
				$div.find('.colParentObj_Input').show();
				$div.find('.c_ParentObj_ExpertSettings').show();
				$div.find('.s_ParentObj_Input_LinkedId').show();

				$div.find('.c_LinkedObj_isLinked').hide();
				$div.find('.s_LinkedObj_parentId').hide();

				if (type === 'number') {
					$div.find('.s_ParentObj_hasUnit').show();
					$div.find('label[id="labelUnit"]').text(_("change unit '{0}' for linked object to").replace("{0}", currentObj.common.unit));

					$div.find('.s_ParentObj_conversion').show();
				} else {
					$div.find('.s_ParentObj_hasUnit').hide();
					$div.find('.s_ParentObj_conversion').hide();
				}

				$div.find('input[id="prefixId"]').on('input', function () {
					let prefixId = $div.find('input[id="prefixId"]').val();
					let stateId = $div.find('input[id="stateId"]').val();

					if (prefixId) {
						$div.find('input[data-field="linkedId"]').val(prefixId + "." + stateId);
					} else {
						$div.find('input[data-field="linkedId"]').val(stateId);
					}
				});

				$div.find('input[id="stateId"]').on('input', function () {
					let prefixId = $div.find('input[id="prefixId"]').val();
					let stateId = $div.find('input[id="stateId"]').val();

					if (prefixId) {
						$div.find('input[data-field="linkedId"]').val(prefixId + "." + stateId);
					} else {
						$div.find('input[data-field="linkedId"]').val(stateId);
					}
				});
			}

			$div.find('input[id="expertSettings"]').on('change', function () {
				// var checked = $(this).prop('checked');

				$div.find('input[data-field="unit"]').prop("disabled", !this.checked);
				$div.find('input[data-field="conversion"]').prop("disabled", !this.checked);
				$div.find('select[id=conversionType]').prop("disabled", !this.checked);

				gMain.showMessage("Halllo");
			});
		}
	}

	if (typeof customPostOnSave !== 'undefined') {
		customPostOnSave.linkeddevices = function ($div, instance) {
			gMain.showMessage("Halllo");
			return 'Please enter ID';
			// if (!$div.find('input[data-field="test"]').val() === "") {
			// 	return _('Please enter ID');
			// }
		};
	}
</script>