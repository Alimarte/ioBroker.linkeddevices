<script type="text/x-iobroker" data-template-name="linkeddevices">
	<div class="parentObject_view">
		<div class="row">
			<div class="col s1">
				<input type="checkbox" data-field="enabled" data-default="false"/>
				<!-- this field is mandatory, just to find out if to include this settings or not</span-->
				<span class="translate">enabled</span>
			</div>
			<div class="col s11">
				<div class="row">
					<div class="col s4">
						<label class="translate">prefix for id of linked object</label>
						<input type="text" id="prefixId">
					</div>
					<div class="col s2">
						<label class="translate">id of linked object</label>
						<input type="text" id="stateId">
					</div>
					<div class="col s6">
						<label class="translate">composite id of linked object</label>
						<input type="text" data-field="linkedId" readonly>	
					</div>
				</div>
				<div class="row">
					<div class="col s4">
						<label class="translate">name of linked object</label>
						<input type="text" data-field="name">
					</div>				
				</div>
			</div>
		</div>

		<div class="parentObject_view_expert">
			<div class="row">
				<hr size="1" noshade style="margin-bottom: 10px">
			</div>
			<div class="row" >
				<div class="col">
					<input type="checkbox" id="expertSettings"/>
					<span id="labelExpertSettings"class="translate">expert settings</span>				
				</div>
			</div>
			<div class="row" style="margin-top: 20px">
				<div class="col s3 s_ParentObj_hasUnit">
					<label id="labelUnit" class="translate">change unit '{0}' for linked object to</label>
					<input type="text" data-field="unit" disabled="true">
				</div>
				<div class="col s3 s_ParentObj_maxDecimal">
					<label class="translate">number of decimal places</label>
					<input type="text" data-field="maxDecimal" disabled="true">
				</div>
				<div class="col s3 s_ParentObj_readOnly_conversion">
					<label class="translate">conversion for read only object</label>
					<input type="text" data-field="readOnlyConversion" disabled="true">
				</div>
				<div class="col s3 s_ParentObj_conversion">
					<label class="translate">conversion for linked object</label>
					<input type="text" data-field="conversion" disabled="true">					
				</div>			
			</div>
		</div>
	</div>

	<div class="linkedObject_view">
		<div class="row">
			<div class="col s1">
				<input type="checkbox" id="isLinked" disabled="true"/>
				<span class="translate">is linked</span>
			</div>
			<div class="col s4">
				<label class="translate">linked with</label>
				<input type="text" id="parentId" readonly>	
			</div>
		</div>
	</div>

	<div class="row">
		<label class="translate">test</label>
		<input type="text" id="test" readonly>				
	</div>	
</script>

<script type="text/javascript">
	$.get("adapter/linkeddevices/words.js", function (script) {
		let translation = script.substring(script.indexOf('{'), script.length);
		translation = translation.substring(0, translation.lastIndexOf(';'));
		$.extend(systemDictionary, JSON.parse(translation));
	});

	// There are two ways how to predefine default settings:
	// - with attribute "data-default" (content independent)
	// - with function in global variable "defaults". Function name is equal with adapter name.
	//   as input function receives object with all information concerning it

	// Objekt holen für das der custom Dialog geöffnet wurde 
	var currentObj = gMain.objects[gMain.navigateGetParams()];

	if (typeof defaults !== 'undefined') {
		defaults.linkeddevices = function (obj, instanceObj) {
			return {
				enabled: false,
				unit: obj.common.unit
			};
		}
	}

	if (typeof customPostInits !== 'undefined') {
		customPostInits.linkeddevices = function ($div, values, instanceObj, type, role) {

			$div.find('input[id="test"]').val(JSON.stringify(currentObj));

			if (values["linkedId"]) {
				var linkedId = values["linkedId"];

				if (values["linkedId"].indexOf(".") > 0) {
					$div.find('input[id="stateId"]').val(linkedId.substring(linkedId.lastIndexOf(".") + 1, linkedId.length));
					$div.find('input[id="prefixId"]').val(linkedId.substring(0, linkedId.lastIndexOf(".")));
				} else {
					$div.find('input[id="stateId"]').val(linkedId);
				}
			} else if (currentObj && currentObj._id) {
				var objId = currentObj._id;
				$div.find('input[id="stateId"]').val(objId.substring(objId.lastIndexOf(".") + 1, objId.length));
				$div.find('input[data-field="linkedId"]').val(objId.substring(objId.lastIndexOf(".") + 1, objId.length));
			}

			if (values["isLinked"] != undefined) {
				//linkedObject			



				$div.find('.linkedObject_view').show();
				$div.find('input[id="isLinked"]').prop('checked', values["isLinked"]);

				$div.find('input[id="parentId"]').val(values["parentId"]);

				$div.find('.parentObject_view').hide();
			} else {
				//parentObject
				$div.find('.parentObject_view').show();
				$div.find('.linkedObject_view').hide();

				if (type === 'number' || type === 'string') {
					// Experteneinstellungen anzeigen
					$div.find('.parentObject_view_expert').show();
					$div.find('span[id="labelExpertSettings"]').text(_("expert settings for type '{0}'").replace("{0}", _(currentObj.common.type)));
				} else {
					$div.find('.parentObject_view_expert').hide();
				}

				if (type === 'number') {
					$div.find('.s_ParentObj_hasUnit').show();
					$div.find('label[id="labelUnit"]').text(_("change unit '{0}' for linked object to").replace("{0}", currentObj.common.unit));

					$div.find('.s_ParentObj_maxDecimal').show();
					$div.find('input[data-field="maxDecimal"]').keyup(function () {
						// Nur Nummern und math operators zulassen
						let allowedSigns = /[^0-9]/;

						if (allowedSigns.test(this.value)) {
							gMain.showError(_("only numbers allowed"));
						}
						this.value = this.value.replace(allowedSigns, '');
					});

					if (currentObj.common.read === true && currentObj.common.write === false) {
						// Number ist readOnly
						$div.find('.s_ParentObj_readOnly_conversion').show();
						$div.find('.s_ParentObj_conversion').hide();

						$div.find('input[data-field="readOnlyConversion"]').keyup(function () {
							// Nur Nummern und math operators zulassen
							let allowedSigns = /[^0-9\.\,\*\+\-\/\(\)]/;

							if (this.value.length > 0) {
								if (allowedSigns.test(this.value)) {
									// prüfen auf zulässige Zeichen
									gMain.showError(_("only numbers and math operators allowed for read only object"));
								} else if (!this.value.startsWith("+") && !this.value.startsWith("-") && !this.value.startsWith("*") && !this.value.startsWith("/")) {
									// muss mit math operator beginnen
									this.value = "";
									gMain.showError(_("only numbers and math operators allowed for read only object"));
								}
							}

							this.value = this.value.replace(allowedSigns, '');
						});

					} else {
						$div.find('.s_ParentObj_conversion').show();
						$div.find('input[data-field="conversion"]').keyup(function () {
							// Nur Nummern und math operators * | / zulassen
							let allowedSigns = /[^0-9\.\,\*\/]/;

							if (this.value.length > 0) {
								if (allowedSigns.test(this.value)) {
									// prüfen auf zulässige Zeichen
									gMain.showError(_("only numbers and math operators allowed"));
								} else if (!this.value.startsWith("*") && !this.value.startsWith("/")) {
									// muss mit math operator beginnen
									this.value = "";
									gMain.showError(_("only numbers and math operators allowed"));
								}
							}

							this.value = this.value.replace(allowedSigns, '');

						});

						$div.find('.s_ParentObj_readOnly_conversion').hide();
					}
				} else {
					$div.find('.s_ParentObj_hasUnit').hide();
					$div.find('.s_ParentObj_maxDecimal').hide();
					$div.find('.s_ParentObj_conversion').hide();
					$div.find('.s_ParentObj_readOnly_conversion').hide();
				}

				$div.find('input[id="prefixId"]').on('input', function () {
					let prefixId = $div.find('input[id="prefixId"]').val();
					let stateId = $div.find('input[id="stateId"]').val();

					if (prefixId) {
						$div.find('input[data-field="linkedId"]').val(prefixId + "." + stateId);
					} else {
						$div.find('input[data-field="linkedId"]').val(stateId);
					}
				});

				$div.find('input[id="stateId"]').on('input', function () {
					let prefixId = $div.find('input[id="prefixId"]').val();
					let stateId = $div.find('input[id="stateId"]').val();

					if (prefixId) {
						$div.find('input[data-field="linkedId"]').val(prefixId + "." + stateId);
					} else {
						$div.find('input[data-field="linkedId"]').val(stateId);
					}
				});

				$div.find('input[id="expertSettings"]').on('change', function () {
					// var checked = $(this).prop('checked');

					$div.find('input[data-field="unit"]').prop("disabled", !this.checked);
					$div.find('input[data-field="maxDecimal"]').prop("disabled", !this.checked);
					$div.find('input[data-field="conversion"]').prop("disabled", !this.checked);
					$div.find('input[data-field="readOnlyConversion"]').prop("disabled", !this.checked);
					$div.find('select[id=conversionType]').prop("disabled", !this.checked);

					//gMain.showMessage("Halllo");
				});
			}
		}
	}

	if (typeof customPostOnSave !== 'undefined') {
		customPostOnSave.linkeddevices = function ($div, instance) {
			gMain.showMessage("Halllo");
			return 'Please enter ID';
			// if (!$div.find('input[data-field="test"]').val() === "") {
			// 	return _('Please enter ID');
			// }
		};
	}
</script>