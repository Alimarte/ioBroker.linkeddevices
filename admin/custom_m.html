<script type="text/x-iobroker" data-template-name="linkeddevices">
	<div class="parentObject_view">
		<div class="row">
			<div class="col s2">
				<input type="checkbox" data-field="enabled" data-default="false"/>
				<!-- this field is mandatory, just to find out if to include this settings or not</span-->
				<span class="translate">enabled</span>
			</div>
			<div class="col s10">
				<div class="row">
					<div class="col s4">
						<label class="translate">prefix for id of linked object</label>
						<input type="text" id="IN_prefixId">
					</div>
					<div class="col s2">
						<label class="translate">id of linked object</label>
						<input type="text" id="IN_stateId">
					</div>
					<div class="col s6">
						<label class="translate">composite id of linked object</label>
						<input type="text" data-field="linkedId" readonly>	
					</div>
				</div>
				<div class="row">
					<div class="col s4">
						<label class="translate">name of linked object</label>
						<input type="text" data-field="name">
					</div>				
				</div>
			</div>
		</div>

		<div class="view_expertSettings">
			<div class="row">
				<hr size="1" noshade style="margin-bottom: 10px">
			</div>
			<div class="row" >
				<div class="col">
					<input type="checkbox" data-field="expertSettings"/>
					<span id="SP_expertSettings" class="translate">expert settings</span>				
				</div>
			</div>
			<div class="view_expertSettings_Number">
				<div class="row" style="margin-top: 20px">
					<div class="col s3">
						<label class="translate">convert linked object to type</label>				
						<select data-field="number_converTo" data-default="">
							<option value="" 			class="translate">do not convert</option>
							<option value="boolean" 	class="translate">Boolean</option>
							<option value="string" 		class="translate">String</option>
						</select>
					</div>
					<div class="view_expertSettings_Number_Converter_None">										
						<div class="col s3">
							<label id="LB_unit" class="translate">change unit '{0}' for linked object to</label>
							<input type="text" data-field="number_unit">
						</div>
						<div class="col s3">
							<label class="translate">max. number of decimal places</label>
							<input type="text" data-field="number_maxDecimal">
						</div>
						<div class="col s3 view_expertSettings_Number_conversion">
							<label class="translate">conversion for linked object</label>
							<input type="text" data-field="number_calculation">					
						</div>					
						<div class="col s3 view_expertSettings_Number_conversion_readOnly">
							<label class="translate">conversion for 'read' object</label>
							<input type="text" data-field="readOnlyConversion">
						</div>
					</div>
					<div class="view_expertSettings_Number_Converter_Boolean">
						<div class="col s3">
							<label class="translate">condition 'true' for linked object</label>
							<input type="text" data-field="condition_number_boolean_linked_object">
						</div>
						<div class="view_expertSettings_Number_Converter_Boolean_notReadOnly">
							<div class="col s3">
								<label class="translate">value if linked object is 'true'</label>
								<input type="number" data-field="true_value_number_boolean_parent_object">
							</div>
							<div class="col s3">
								<label class="translate">value if linked object is 'false'</label>
								<input type="number" data-field="false_value_number_boolean_parent_object">
							</div>												
						</div>
					</div>			
				</div>
			</div>
		</div>
	</div>

	<div class="linkedObject_view">
		<div class="row">
			<div class="col s2">
				<input type="checkbox" id="CB_isLinked" disabled="true"/>
				<span class="translate">is linked</span>
			</div>
			<div class="col s4">
				<label class="translate">linked with</label>
				<input type="text" id="IN_parentId" readonly>	
			</div>
		</div>
	</div>

	<div class="row">
		<label class="translate">test</label>
		<input type="text" id="test" readonly>				
	</div>	
</script>

<script type="text/javascript">
	$.get("adapter/linkeddevices/words.js", function (script) {
		let translation = script.substring(script.indexOf('{'), script.length);
		translation = translation.substring(0, translation.lastIndexOf(';'));
		$.extend(systemDictionary, JSON.parse(translation));
	});

	// There are two ways how to predefine default settings:
	// - with attribute "data-default" (content independent)
	// - with function in global variable "defaults". Function name is equal with adapter name.
	//   as input function receives object with all information concerning it

	// Objekt holen für das der custom Dialog geöffnet wurde 
	var currentObj = gMain.objects[gMain.navigateGetParams()];

	if (typeof defaults !== 'undefined') {
		defaults.linkeddevices = function (obj, instanceObj) {
			return {
				enabled: false,
				number_unit: obj.common.number_unit
			};
		}
	}

	if (typeof customPostInits !== 'undefined') {
		customPostInits.linkeddevices = function ($div, values, instanceObj, type, role) {

			var ComboBox = {};
			var Group = {};
			var Input = {};
			var Select = {};
			var Label = {};

			// vars die sich verändern können und für conditions benötigt werden
			var isCustomEnabled = false;
			if (values["enabled"]) isCustomEnabled = values["enabled"];

			var expertSettingsActivated = false;
			if (values["expertSettings"]) expertSettingsActivated = values["expertSettings"];

			var selectedNumberConverter = "";
			if (values["number_converTo"]) selectedNumberConverter = values["number_converTo"];

			$div.find('input[id="test"]').val(JSON.stringify(currentObj));

			$div.ready(function () {
				//$div.find('.view_expertSettings_Number').hide();
				// Event Document ready -> hier kann select disabled = 'true' gesetzt werden, da sonst options weg sind bzw. enabled nicht geht
				//$div.find('.view_expertSettings_Number_Converter').find('*').prop('disabled', true);

			});

			// Divs in vars packen
			initialize_Divs();

			if (values["isLinked"] != undefined) {
				// Custom Dialog für LinkedObject
				initialize_LinkedObject();

			} else {
				// Custom Dialog für ParentObject
				initialize_ParentObject();

				// EventHandler
				events_ParentObject();

				// ExpertSettings initialisieren
				initialize_ExpertSettings();
			}

			//#region Initialize
			function initialize_Divs() {
				// alle ComboBoxen in vars packen
				ComboBox.enabled = $div.find('input[data-field="enabled"]');
				ComboBox.expertSettings = $div.find('input[data-field="expertSettings"]');
				ComboBox.isLinked = $div.find('input[id="CB_isLinked"]');

				// alle groups in vars packen			
				Group.linkedObject = $div.find('.linkedObject_view');
				Group.parentObject = $div.find('.parentObject_view');
				Group.expertSettings = $div.find('.view_expertSettings');
				Group.expertSettings_Number = $div.find('.view_expertSettings_Number');
				Group.expertSettings_Number_Converter_None = $div.find('.view_expertSettings_Number_Converter_None');
				Group.expertSettings_Number_Converter_Boolean = $div.find('.view_expertSettings_Number_Converter_Boolean');
				Group.expertSettings_Number_Converter_Boolean_notReadOnly = $div.find('.view_expertSettings_Number_Converter_Boolean_notReadOnly');
				Group.expertSettings_Number_Conversion = $div.find('.view_expertSettings_Number_conversion');
				Group.expertSettings_Number_Conversion_ReadOnly = $div.find('.view_expertSettings_Number_conversion_readOnly');

				// alle input in vars packen
				Input.parentId = $div.find('input[id="IN_parentId"]');
				Input.stateId = $div.find('input[id="IN_stateId"]');
				Input.prefixId = $div.find('input[id="IN_prefixId"]');
				Input.linkedId = $div.find('input[data-field="linkedId"]');
				Input.number_maxDecimal = $div.find('input[data-field="number_maxDecimal"]');
				Input.number_calculation = $div.find('input[data-field="number_calculation"]');
				Input.readOnlyConversion = $div.find('input[data-field="readOnlyConversion"]');

				// alle select in var packen
				Select.number_converTo = $div.find('select[data-field="number_converTo"]');

				// alle label / span in var packen
				Label.expertSettings = $div.find('span[id="SP_expertSettings"]');
				Label.number_unit = $div.find('label[id="LB_unit"]');
			}

			function initialize_LinkedObject() {
				// Custom Dialog für LinkedObject: Views initialisieren
				Group.linkedObject.show();
				Group.parentObject.hide();

				// Checkbox Wert setzen
				ComboBox.isLinked.prop('checked', values["isLinked"]);
				// parentId anzeigen
				Input.parentId.val(values["parentId"]);
			}

			function initialize_ParentObject() {
				// Custom Dialog für ParentObject: Views initialisieren
				Group.parentObject.show();
				Group.linkedObject.hide();

				if (values["linkedId"]) {
					// ParentObject ist verlinkt
					var linkedId = values["linkedId"];

					// linkedId aufteilen in prefix & stateId
					if (values["linkedId"].indexOf(".") > 0) {
						Input.stateId.val(linkedId.substring(linkedId.lastIndexOf(".") + 1, linkedId.length));
						Input.prefixId.val(linkedId.substring(0, linkedId.lastIndexOf(".")));
					} else {
						Input.stateId.val(linkedId);
					}
				} else if (currentObj && currentObj._id) {
					// ParentObject ist noch nicht verlinkt
					var objId = currentObj._id;

					// stateId des ParentObjects holen
					Input.stateId.val(objId.substring(objId.lastIndexOf(".") + 1, objId.length));
					Input.linkedId.val(objId.substring(objId.lastIndexOf(".") + 1, objId.length));
				}
			}

			function initialize_ExpertSettings() {
				if (isCustomEnabled && (type === 'number' || type === 'string')) {
					// Experteneinstellungen anzeigen, sofern für type vorhanden
					Group.expertSettings.show();
					Label.expertSettings.text(_("expert settings for type '{0}'").replace("{0}", _(currentObj.common.type)));

					// Views initalisieren
					initialize_ExpertSettings_Number();

					// EventHandler für alle ExpertSettings
					events_ExpertSettings();

				} else {
					Group.expertSettings.hide();
				}
			}

			function initialize_ExpertSettings_Number() {
				// ExpertSettings für type 'number' initialisieren				

				// wenn expertSettings aktiviert sind und typ = number -> Eingabefelder anzeigen
				if (type === 'number' && expertSettingsActivated) {
					Group.expertSettings_Number.show();

					Label.number_unit.text(_("change unit '{0}' for linked object to").replace("{0}", currentObj.common.unit));

					// Prüfen ob Typ Konverter ausgewählt ist
					if (selectedNumberConverter === "") {
						Group.expertSettings_Number_Converter_None.show();

						// Number ist read only
						if (currentObj.common.read === true && currentObj.common.write === false) {
							Group.expertSettings_Number_Conversion_ReadOnly.show();
							Group.expertSettings_Number_Conversion.hide();
						} else {
							Group.expertSettings_Number_Conversion.show();
							Group.expertSettings_Number_Conversion_ReadOnly.hide();
						}

						Group.expertSettings_Number_Converter_Boolean.hide();
						Group.expertSettings_Number_Converter_Boolean.find("input").val("");
					} else if (selectedNumberConverter === "boolean") {
						Group.expertSettings_Number_Converter_Boolean.show();

						// Number ist read only
						if (currentObj.common.read === true && currentObj.common.write === false) {
							Group.expertSettings_Number_Converter_Boolean_notReadOnly.hide();
						} else {
							Group.expertSettings_Number_Converter_Boolean_notReadOnly.show();
						}

						Group.expertSettings_Number_Converter_None.hide();
						Group.expertSettings_Number_Converter_None.find("input").val("");

					} else if (selectedNumberConverter === "string") {
						Group.expertSettings_Number_Converter_None.hide();
						Group.expertSettings_Number_Converter_None.find("input").val("");
						Group.expertSettings_Number_Converter_Boolean.hide();
						Group.expertSettings_Number_Converter_Boolean.find("input").val("");
					}

					// Event Handler für ExpertSettings mit type 'number'
					events_ExpertSettings_Number();

				} else {
					// Ausblenden und alle Eingaben löschen
					Group.expertSettings_Number.hide();
					Group.expertSettings_Number.find("input").val("");
					Group.expertSettings_Number.find("select").val("");
				}
			}

			//#endregion

			//#region Events
			function events_ParentObject() {
				ComboBox.enabled.on('change', function () {
					// var checked = $(this).prop('checked');
					isCustomEnabled = this.checked;
					initialize_ExpertSettings();
				});

				Input.prefixId.on('input', function () {
					// Bei Eingabe 'linkedId' zusammensetzen und prüfen auf erlaubte Zeichen
					let notAllowedSigns = /[*?"'\[\]]/;

					if (this.value.length > 0 && notAllowedSigns.test(this.value)) {
						// prüfen auf zulässige Zeichen
						this.value = this.value.replace(notAllowedSigns, '');
						gMain.showError(_("not allowed chars for Id"));
					} else {
						// 'linkedId' zusammensetzen
						let prefixId = Input.prefixId.val();
						let stateId = Input.stateId.val();

						if (prefixId) {
							Input.linkedId.val((prefixId + "." + stateId).replace("..", "."));
						} else {
							Input.linkedId.val(stateId);
						}
					}
				});

				Input.stateId.on('input', function () {
					// Bei Eingabe 'linkedId' zusammensetzen und prüfen auf erlaubte Zeichen
					let notAllowedSigns = /[*?"'\[\]]/;

					if (this.value.length > 0 && notAllowedSigns.test(this.value)) {
						// prüfen auf zulässige Zeichen
						this.value = this.value.replace(notAllowedSigns, '');
						gMain.showError(_("not allowed chars for Id"));
					} else {
						// Bei Eingabe 'linkedId' zusammensetzen und prüfen auf erlaubte Zeichen
						let prefixId = Input.prefixId.val();
						let stateId = Input.stateId.val();

						if (prefixId) {
							Input.linkedId.val((prefixId + "." + stateId).replace("..", "."));
						} else {
							Input.linkedId.val(stateId);
						}
					}
				});
			}

			function events_ExpertSettings() {
				// Event für CheckBox ExpertSettings
				ComboBox.expertSettings.on('change', function () {
					// var checked = $(this).prop('checked');
					expertSettingsActivated = this.checked;
					initialize_ExpertSettings_Number();
				});
			}

			function events_ExpertSettings_Number() {
				// Anzahl Nachkommastellen - Eingabe prüfen
				Input.number_maxDecimal.keyup(function () {
					// Nur Nummern zulassen
					let allowedSigns = /[^0-9]/;

					if (allowedSigns.test(this.value)) {
						gMain.showError(_("only numbers allowed"));
					}
					this.value = this.value.replace(allowedSigns, '');
				});

				// Umrechnung für read & write - Eingabe prüfen
				Input.number_calculation.keyup(function () {
					// Nur Nummern und math operators * | / zulassen
					let allowedSigns = /[^0-9\.\,\*\/]/;

					if (this.value.length > 0) {
						if (allowedSigns.test(this.value)) {
							// prüfen auf zulässige Zeichen
							gMain.showError(_("only numbers and math operators allowed"));
						} else if (!this.value.startsWith("*") && !this.value.startsWith("/")) {
							// muss mit math operator beginnen
							this.value = "";
							gMain.showError(_("only numbers and math operators allowed"));
						}
					}
					this.value = this.value.replace(allowedSigns, '');
				});

				// Umrechnung für read only - Eingabe prüfen
				Input.readOnlyConversion.keyup(function () {
					// Nur Nummern und math operators zulassen
					let allowedSigns = /[^0-9\.\,\*\+\-\/\(\)]/;

					if (this.value.length > 0) {
						if (allowedSigns.test(this.value)) {
							// prüfen auf zulässige Zeichen
							gMain.showError(_("only numbers and math operators allowed for read only object"));
						} else if (!this.value.startsWith("+") && !this.value.startsWith("-") && !this.value.startsWith("*") && !this.value.startsWith("/")) {
							// muss mit math operator beginnen
							this.value = "";
							gMain.showError(_("only numbers and math operators allowed for read only object"));
						}
					}
					this.value = this.value.replace(allowedSigns, '');
				});

				Select.number_converTo.on('change', function () {
					selectedNumberConverter = this.value;
					initialize_ExpertSettings_Number();
				});
			}

			//#endregion
		}
	}

	if (typeof customPostOnSave !== 'undefined') {
		customPostOnSave.linkeddevices = function ($div, instance) {
			gMain.showMessage("Halllo");
			return 'Please enter ID';
			// if (!$div.find('input[data-field="test"]').val() === "") {
			// 	return _('Please enter ID');
			// }
		};
	}
</script>