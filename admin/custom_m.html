<script type="text/x-iobroker" data-template-name="linkeddevices">
	<div class="parentObject_view">
		<div class="row">
			<div class="col s2">
				<input type="checkbox" data-field="enabled" data-default="false"/>
				<!-- this field is mandatory, just to find out if to include this settings or not</span-->
				<span class="translate">enabled</span>
			</div>
			<div class="col s10">
				<div class="row">
					<div class="col s4">
						<label class="translate">prefix for id of linked object</label>
						<input type="text" id="IN_prefixId">
					</div>
					<div class="col s2">
						<label class="translate">id of linked object</label>
						<input type="text" id="IN_stateId">
					</div>
					<div class="col s6">
						<label class="translate">composite id of linked object</label>
						<input type="text" data-field="linkedId" readonly>	
					</div>
				</div>
				<div class="row">
					<div class="col s4">
						<label class="translate">name of linked object</label>
						<input type="text" data-field="name">
					</div>				
				</div>
			</div>
		</div>

		<div class="parentObject_view_expertSettings">
			<div class="row">
				<hr size="1" noshade style="margin-bottom: 10px">
			</div>
			<div class="row" >
				<div class="col">
					<input type="checkbox" id="CB_expertSettings"/>
					<span id="SP_expertSettings" class="translate">expert settings</span>				
				</div>
			</div>
			<div class="parentObject_view_expertSettings_Number" disabled="true">
				<div class="row" style="margin-top: 20px">
					<div class="col s3 s_ParentObj_hasUnit">
						<label id="LB_unit" class="translate">change unit '{0}' for linked object to</label>
						<input type="text" data-field="unit" disabled="true">
					</div>
					<div class="col s3 s_ParentObj_maxDecimal">
						<label class="translate">number of decimal places</label>
						<input type="text" data-field="maxDecimal" disabled="true">
					</div>
					<div class="col s3 s_ParentObj_readOnly_conversion">
						<label class="translate">conversion for read only object</label>
						<input type="text" data-field="readOnlyConversion" disabled="true">
					</div>
					<div class="col s3 s_ParentObj_conversion">
						<label class="translate">conversion for linked object</label>
						<input type="text" data-field="conversion" disabled="true">					
					</div>			
				</div>
			</div>
		</div>
	</div>

	<div class="linkedObject_view">
		<div class="row">
			<div class="col s2">
				<input type="checkbox" id="CB_isLinked" disabled="true"/>
				<span class="translate">is linked</span>
			</div>
			<div class="col s4">
				<label class="translate">linked with</label>
				<input type="text" id="IN_parentId" readonly>	
			</div>
		</div>
	</div>

	<div class="row">
		<label class="translate">test</label>
		<input type="text" id="test" readonly>				
	</div>	
</script>

<script type="text/javascript">
	$.get("adapter/linkeddevices/words.js", function (script) {
		let translation = script.substring(script.indexOf('{'), script.length);
		translation = translation.substring(0, translation.lastIndexOf(';'));
		$.extend(systemDictionary, JSON.parse(translation));
	});

	// There are two ways how to predefine default settings:
	// - with attribute "data-default" (content independent)
	// - with function in global variable "defaults". Function name is equal with adapter name.
	//   as input function receives object with all information concerning it

	// Objekt holen für das der custom Dialog geöffnet wurde 
	var currentObj = gMain.objects[gMain.navigateGetParams()];

	if (typeof defaults !== 'undefined') {
		defaults.linkeddevices = function (obj, instanceObj) {
			return {
				enabled: false,
				unit: obj.common.unit
			};
		}
	}

	if (typeof customPostInits !== 'undefined') {
		customPostInits.linkeddevices = function ($div, values, instanceObj, type, role) {



			$div.find('input[id="test"]').val(JSON.stringify(currentObj));



			if (values["isLinked"] != undefined) {
				// Custom Dialog für LinkedObject
				initialize_LinkedObject();

			} else {
				// Custom Dialog für ParentObject
				initialize_ParentObject();

				// EventHandler
				events_ParentObject();

				// ExpertSettings initialisieren
				initialize_ParentObject_ExpertSettings();



				// if (type === 'number') {
				// 	$div.find('.s_ParentObj_hasUnit').show();
				// 	$div.find('label[id="LB_unit"]').text(_("change unit '{0}' for linked object to").replace("{0}", currentObj.common.unit));

				// 	$div.find('.s_ParentObj_maxDecimal').show();
				// 	$div.find('input[data-field="maxDecimal"]').keyup(function () {
				// 		// Nur Nummern und math operators zulassen
				// 		let allowedSigns = /[^0-9]/;

				// 		if (allowedSigns.test(this.value)) {
				// 			gMain.showError(_("only numbers allowed"));
				// 		}
				// 		this.value = this.value.replace(allowedSigns, '');
				// 	});

				// 	if (currentObj.common.read === true && currentObj.common.write === false) {
				// 		// Number ist readOnly
				// 		$div.find('.s_ParentObj_readOnly_conversion').show();
				// 		$div.find('.s_ParentObj_conversion').hide();

				// 		$div.find('input[data-field="readOnlyConversion"]').keyup(function () {
				// 			// Nur Nummern und math operators zulassen
				// 			let allowedSigns = /[^0-9\.\,\*\+\-\/\(\)]/;

				// 			if (this.value.length > 0) {
				// 				if (allowedSigns.test(this.value)) {
				// 					// prüfen auf zulässige Zeichen
				// 					gMain.showError(_("only numbers and math operators allowed for read only object"));
				// 				} else if (!this.value.startsWith("+") && !this.value.startsWith("-") && !this.value.startsWith("*") && !this.value.startsWith("/")) {
				// 					// muss mit math operator beginnen
				// 					this.value = "";
				// 					gMain.showError(_("only numbers and math operators allowed for read only object"));
				// 				}
				// 			}

				// 			this.value = this.value.replace(allowedSigns, '');
				// 		});

				// 	} else {
				// 		$div.find('.s_ParentObj_conversion').show();
				// 		$div.find('input[data-field="conversion"]').keyup(function () {
				// 			// Nur Nummern und math operators * | / zulassen
				// 			let allowedSigns = /[^0-9\.\,\*\/]/;

				// 			if (this.value.length > 0) {
				// 				if (allowedSigns.test(this.value)) {
				// 					// prüfen auf zulässige Zeichen
				// 					gMain.showError(_("only numbers and math operators allowed"));
				// 				} else if (!this.value.startsWith("*") && !this.value.startsWith("/")) {
				// 					// muss mit math operator beginnen
				// 					this.value = "";
				// 					gMain.showError(_("only numbers and math operators allowed"));
				// 				}
				// 			}

				// 			this.value = this.value.replace(allowedSigns, '');

				// 		});

				// 		$div.find('.s_ParentObj_readOnly_conversion').hide();
				// 	}
				// } else {
				// 	$div.find('.s_ParentObj_hasUnit').hide();
				// 	$div.find('.s_ParentObj_maxDecimal').hide();
				// 	$div.find('.s_ParentObj_conversion').hide();
				// 	$div.find('.s_ParentObj_readOnly_conversion').hide();
				// }





				//TODO -> Id nicht erlaubte zeichen abfangen
			}

			function initialize_LinkedObject() {
				// Custom Dialog für LinkedObject: Views initialisieren
				$div.find('.linkedObject_view').show();
				$div.find('.parentObject_view').hide();

				// Checkbox Wert setzen
				$div.find('input[id="CB_isLinked"]').prop('checked', values["isLinked"]);
				// parentId anzeigen
				$div.find('input[id="IN_parentId"]').val(values["parentId"]);
			}

			function initialize_ParentObject() {
				// Custom Dialog für ParentObject: Views initialisieren
				$div.find('.parentObject_view').show();
				$div.find('.linkedObject_view').hide();

				if (values["linkedId"]) {
					// ParentObject ist verlinkt
					var linkedId = values["linkedId"];

					// linkedId aufteilen in prefix & stateId
					if (values["linkedId"].indexOf(".") > 0) {
						$div.find('input[id="IN_stateId"]').val(linkedId.substring(linkedId.lastIndexOf(".") + 1, linkedId.length));
						$div.find('input[id="IN_prefixId"]').val(linkedId.substring(0, linkedId.lastIndexOf(".")));
					} else {
						$div.find('input[id="IN_stateId"]').val(linkedId);
					}
				} else if (currentObj && currentObj._id) {
					// ParentObject ist noch nicht verlinkt
					var objId = currentObj._id;

					// stateId des ParentObjects holen
					$div.find('input[id="IN_stateId"]').val(objId.substring(objId.lastIndexOf(".") + 1, objId.length));
					$div.find('input[data-field="linkedId"]').val(objId.substring(objId.lastIndexOf(".") + 1, objId.length));
				}
			}

			function initialize_ParentObject_ExpertSettings() {
				if (type === 'number' || type === 'string') {
					// Experteneinstellungen anzeigen, sofern für type vorhanden
					$div.find('.parentObject_view_expertSettings').show();
					$div.find('span[id="SP_expertSettings"]').text(_("expert settings for type '{0}'").replace("{0}", _(currentObj.common.type)));

					//zuerst alle views ausblenden
					$div.find('.parentObject_view_expertSettings_Number').hide();

					// Views abhängig vom type anzeigen oder ausblenden
					if (type === 'number') {
						initialize_ParentObject_ExpertSettings_Number();
					}

					// EventHandler für alle ExpertSettings
					events_ParentObject_ExpertSettings();

				} else {
					$div.find('.parentObject_view_expertSettings').hide();
				}
			}

			function initialize_ParentObject_ExpertSettings_Number() {
				// ExpertSettings für type 'number' initialisieren
				$div.find('.parentObject_view_expertSettings_Number').show();

				$div.find('label[id="LB_unit"]').text(_("change unit '{0}' for linked object to").replace("{0}", currentObj.common.unit));

				// Number ist read only
				if (currentObj.common.read === true && currentObj.common.write === false) {
					$div.find('.s_ParentObj_readOnly_conversion').show();
					$div.find('.s_ParentObj_conversion').hide();
				} else {
					$div.find('.s_ParentObj_conversion').show();
					$div.find('.s_ParentObj_readOnly_conversion').hide();
				}


			}

			function events_ParentObject() {
				$div.find('input[id="IN_prefixId"]').on('input', function () {
					// Bei Eingabe 'linkedId' zusammensetzen und prüfen auf erlaubte Zeichen
					let notAllowedSigns = /[*?"'\[\]]/;

					if (this.value.length > 0) {
						if (notAllowedSigns.test(this.value)) {
							// prüfen auf zulässige Zeichen
							this.value = this.value.replace(notAllowedSigns, '');
							gMain.showError(_("not allowed chars for Id"));
						} else {
							// 'linkedId' zusammensetzen
							let prefixId = $div.find('input[id="IN_prefixId"]').val();
							let stateId = $div.find('input[id="IN_stateId"]').val();

							if (prefixId) {
								$div.find('input[data-field="linkedId"]').val((prefixId + "." + stateId).replace("..", "."));
							} else {
								$div.find('input[data-field="linkedId"]').val(stateId);
							}
						}
					}
				});

				$div.find('input[id="IN_stateId"]').on('input', function () {
					// Bei Eingabe 'linkedId' zusammensetzen und prüfen auf erlaubte Zeichen
					let notAllowedSigns = /[*?"'\[\]]/;

					if (this.value.length > 0) {
						if (notAllowedSigns.test(this.value)) {
							// prüfen auf zulässige Zeichen
							this.value = this.value.replace(notAllowedSigns, '');
							gMain.showError(_("not allowed chars for Id"));
						} else {
							// Bei Eingabe 'linkedId' zusammensetzen und prüfen auf erlaubte Zeichen
							let prefixId = $div.find('input[id="IN_prefixId"]').val();
							let stateId = $div.find('input[id="IN_stateId"]').val();

							if (prefixId) {
								$div.find('input[data-field="linkedId"]').val((prefixId + "." + stateId).replace("..", "."));
							} else {
								$div.find('input[data-field="linkedId"]').val(stateId);
							}
						}
					}

				});
			}

			function events_ParentObject_ExpertSettings() {
				// Event für CheckBox ExpertSettings
				$div.find('input[id="CB_expertSettings"]').on('change', function () {
					// var checked = $(this).prop('checked');

					if (type === 'number') {
						$div.find('.parentObject_view_expertSettings_Number').prop("disabled", !this.checked);
					}

					gMain.showMessage("Halllo");
				});
			}
		}
	}



	if (typeof customPostOnSave !== 'undefined') {
		customPostOnSave.linkeddevices = function ($div, instance) {
			gMain.showMessage("Halllo");
			return 'Please enter ID';
			// if (!$div.find('input[data-field="test"]').val() === "") {
			// 	return _('Please enter ID');
			// }
		};
	}
</script>